<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åˆ†äº«åœ–ç‰‡ç”Ÿæˆå·¥å…· - æƒ…ç·’åº§æ¨™æ¸¬é©—</title>

    <!-- è¼‰å…¥ html2canvas -->
    <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>

    <!-- è¼‰å…¥ä¸»è¦æ¨£å¼è¡¨ -->
    <link rel="stylesheet" href="../css/style.css">
    <!-- è¼‰å…¥åˆ†äº«å¡ç‰‡æ¨£å¼è¡¨ï¼ˆå¿…é ˆï¼ŒåŒ…å« .ig-share-card æ¨£å¼ï¼‰ -->
    <link rel="stylesheet" href="../css/share-card.css">

    <style>
        /* å·¥å…·é é¢å°ˆç”¨æ¨£å¼ */
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: linear-gradient(135deg, #f6d365 0%, #fda085 100%);
            min-height: 100vh;
            padding: 40px 20px;
            margin: 0;
        }

        .tool-container {
            max-width: 900px;
            margin: 0 auto;
            background: white;
            border-radius: 16px;
            padding: 40px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }

        .tool-header {
            text-align: center;
            margin-bottom: 40px;
        }

        .tool-header h1 {
            color: #d97757;
            font-size: 2em;
            margin-bottom: 10px;
        }

        .tool-header p {
            color: #666;
            font-size: 1em;
        }

        .plant-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .plant-card {
            border: 2px solid #e0e0e0;
            border-radius: 12px;
            padding: 20px;
            text-align: center;
            transition: all 0.3s ease;
        }

        .plant-card:hover {
            border-color: #d97757;
            box-shadow: 0 4px 12px rgba(217, 119, 87, 0.2);
        }

        .plant-card__icon {
            font-size: 3em;
            margin-bottom: 10px;
        }

        .plant-card__name {
            font-size: 1.2em;
            font-weight: bold;
            color: #333;
            margin-bottom: 5px;
        }

        .plant-card__key {
            font-size: 0.9em;
            color: #999;
            margin-bottom: 15px;
            font-family: monospace;
        }

        .plant-card__status {
            font-size: 0.9em;
            padding: 5px 10px;
            border-radius: 20px;
            margin-bottom: 10px;
            font-weight: 500;
        }

        .plant-card__status--pending {
            background: #f0f0f0;
            color: #666;
        }

        .plant-card__status--generating {
            background: #fff3cd;
            color: #856404;
        }

        .plant-card__status--success {
            background: #d4edda;
            color: #155724;
        }

        .plant-card__status--error {
            background: #f8d7da;
            color: #721c24;
        }

        .plant-card__btn {
            background: linear-gradient(135deg, #d97757 0%, #e68a68 100%);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1em;
            transition: all 0.3s ease;
            width: 100%;
        }

        .plant-card__btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(217, 119, 87, 0.3);
        }

        .plant-card__btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .global-actions {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-bottom: 30px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #d97757 0%, #e68a68 100%);
            color: white;
            border: none;
            padding: 15px 40px;
            border-radius: 12px;
            font-size: 1.1em;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 12px rgba(217, 119, 87, 0.2);
        }

        .btn-primary:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(217, 119, 87, 0.3);
        }

        .btn-primary:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .btn-secondary {
            background: white;
            color: #d97757;
            border: 2px solid #d97757;
            padding: 15px 40px;
            border-radius: 12px;
            font-size: 1.1em;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-secondary:hover {
            background: #d97757;
            color: white;
        }

        .progress-info {
            text-align: center;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 12px;
            margin-bottom: 30px;
        }

        .progress-info__text {
            font-size: 1.1em;
            color: #333;
            margin-bottom: 10px;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: #e0e0e0;
            border-radius: 4px;
            overflow: hidden;
        }

        .progress-bar__fill {
            height: 100%;
            background: linear-gradient(135deg, #d97757 0%, #e68a68 100%);
            width: 0%;
            transition: width 0.5s ease;
        }

        .instructions {
            background: #e7f3ff;
            border-left: 4px solid #2196F3;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 30px;
        }

        .instructions h3 {
            color: #1976D2;
            margin-top: 0;
            margin-bottom: 10px;
        }

        .instructions ol {
            margin: 10px 0;
            padding-left: 20px;
        }

        .instructions li {
            margin: 8px 0;
            color: #333;
        }

        .note {
            background: #fff3cd;
            border-left: 4px solid #ffc107;
            padding: 15px;
            border-radius: 8px;
            margin-top: 20px;
        }

        .note p {
            margin: 5px 0;
            color: #856404;
        }
    </style>
</head>
<body>
    <div class="tool-container">
        <div class="tool-header">
            <h1>ğŸŒ¿ åˆ†äº«åœ–ç‰‡ç”Ÿæˆå·¥å…·</h1>
            <p>ç‚º 6 ç¨®æ¤ç‰©äººæ ¼é¡å‹ä¸€æ¬¡æ€§ç”Ÿæˆåˆ†äº«åœ–ç‰‡</p>
        </div>

        <div class="instructions">
            <h3>ä½¿ç”¨èªªæ˜</h3>
            <ol>
                <li>é»æ“Šã€Œç”Ÿæˆå…¨éƒ¨åœ–ç‰‡ã€æŒ‰éˆ•ï¼Œå·¥å…·å°‡è‡ªå‹•ä¾åºç”Ÿæˆ 6 å¼µåœ–ç‰‡</li>
                <li>æ¯å¼µåœ–ç‰‡ç”Ÿæˆå¾Œæœƒè‡ªå‹•ä¸‹è¼‰åˆ°æ‚¨çš„ã€Œä¸‹è¼‰ã€è³‡æ–™å¤¾</li>
                <li>ä¸‹è¼‰çš„æª”æ¡ˆåç¨±æ ¼å¼ç‚ºï¼š<code>share-{æ¤ç‰©é¡å‹}.png</code></li>
                <li>å°‡ä¸‹è¼‰çš„ 6 å¼µåœ–ç‰‡ç§»å‹•åˆ°å°ˆæ¡ˆçš„ <code>share/</code> è³‡æ–™å¤¾</li>
                <li>é‡æ–°å‘½åæª”æ¡ˆï¼Œç§»é™¤ <code>share-</code> å‰ç¶´ï¼ˆä¾‹å¦‚ï¼š<code>share-lavender.png</code> â†’ <code>lavender.png</code>ï¼‰</li>
            </ol>
        </div>

        <div class="progress-info" id="progressInfo" style="display: none;">
            <div class="progress-info__text" id="progressText">æº–å‚™ç”Ÿæˆ...</div>
            <div class="progress-bar">
                <div class="progress-bar__fill" id="progressFill"></div>
            </div>
        </div>

        <div class="global-actions">
            <button class="btn-primary" id="generateAllBtn">ğŸš€ ç”Ÿæˆå…¨éƒ¨åœ–ç‰‡</button>
            <button class="btn-secondary" id="resetBtn" style="display: none;">ğŸ”„ é‡ç½®ç‹€æ…‹</button>
        </div>

        <div class="plant-grid" id="plantGrid">
            <!-- æ¤ç‰©å¡ç‰‡å°‡ç”± JavaScript å‹•æ…‹ç”Ÿæˆ -->
        </div>

        <div class="note">
            <p><strong>æ³¨æ„äº‹é …ï¼š</strong></p>
            <p>â€¢ åœ–ç‰‡å°ºå¯¸ç‚º 1080Ã—1600pxï¼Œé©åˆ Instagram åˆ†äº«</p>
            <p>â€¢ ç”Ÿæˆéç¨‹ä¸­è«‹å‹¿é—œé–‰é é¢</p>
            <p>â€¢ å¦‚æœç”Ÿæˆå¤±æ•—ï¼Œè«‹æª¢æŸ¥ç€è¦½å™¨æ˜¯å¦å…è¨±å¤šæ¬¡ä¸‹è¼‰</p>
        </div>
    </div>

    <script type="module">
        import { plantData } from '../js/data/plants.js';
        import { ShareManager } from '../js/share.js';

        // åˆå§‹åŒ–
        const shareManager = new ShareManager();
        const plantKeys = Object.keys(plantData);
        const plantGrid = document.getElementById('plantGrid');
        const generateAllBtn = document.getElementById('generateAllBtn');
        const resetBtn = document.getElementById('resetBtn');
        const progressInfo = document.getElementById('progressInfo');
        const progressText = document.getElementById('progressText');
        const progressFill = document.getElementById('progressFill');

        // æ¤ç‰©ç‹€æ…‹è¿½è¹¤
        const plantStatus = {};
        plantKeys.forEach(key => {
            plantStatus[key] = 'pending'; // pending, generating, success, error
        });

        // æ¸²æŸ“æ¤ç‰©å¡ç‰‡
        function renderPlantCards() {
            plantGrid.innerHTML = '';

            plantKeys.forEach(key => {
                const plant = plantData[key];
                const card = document.createElement('div');
                card.className = 'plant-card';
                card.id = `card-${key}`;

                let statusText = 'ç­‰å¾…ç”Ÿæˆ';
                let statusClass = 'pending';

                switch (plantStatus[key]) {
                    case 'generating':
                        statusText = 'ç”Ÿæˆä¸­...';
                        statusClass = 'generating';
                        break;
                    case 'success':
                        statusText = 'âœ“ å·²ç”Ÿæˆ';
                        statusClass = 'success';
                        break;
                    case 'error':
                        statusText = 'âœ— ç”Ÿæˆå¤±æ•—';
                        statusClass = 'error';
                        break;
                }

                card.innerHTML = `
                    <div class="plant-card__icon">${plant.icon}</div>
                    <div class="plant-card__name">${plant.name}</div>
                    <div class="plant-card__key">${key}</div>
                    <div class="plant-card__status plant-card__status--${statusClass}" id="status-${key}">
                        ${statusText}
                    </div>
                    <button class="plant-card__btn" id="btn-${key}">
                        ç”Ÿæˆæ­¤åœ–ç‰‡
                    </button>
                `;

                plantGrid.appendChild(card);

                // ç¶å®šå–®ç¨ç”ŸæˆæŒ‰éˆ•
                const btn = document.getElementById(`btn-${key}`);
                btn.addEventListener('click', () => generateSingleImage(key));
            });
        }

        // æ›´æ–°æ¤ç‰©ç‹€æ…‹
        function updatePlantStatus(key, status) {
            plantStatus[key] = status;
            const statusEl = document.getElementById(`status-${key}`);
            const btn = document.getElementById(`btn-${key}`);

            if (!statusEl) return;

            statusEl.className = 'plant-card__status';

            switch (status) {
                case 'pending':
                    statusEl.classList.add('plant-card__status--pending');
                    statusEl.textContent = 'ç­‰å¾…ç”Ÿæˆ';
                    btn.disabled = false;
                    break;
                case 'generating':
                    statusEl.classList.add('plant-card__status--generating');
                    statusEl.textContent = 'ç”Ÿæˆä¸­...';
                    btn.disabled = true;
                    break;
                case 'success':
                    statusEl.classList.add('plant-card__status--success');
                    statusEl.textContent = 'âœ“ å·²ç”Ÿæˆ';
                    btn.disabled = false;
                    break;
                case 'error':
                    statusEl.classList.add('plant-card__status--error');
                    statusEl.textContent = 'âœ— ç”Ÿæˆå¤±æ•—';
                    btn.disabled = false;
                    break;
            }
        }

        // æ›´æ–°é€²åº¦æ¢
        function updateProgress(current, total) {
            const percentage = (current / total) * 100;
            progressFill.style.width = percentage + '%';
            progressText.textContent = `å·²ç”Ÿæˆ ${current} / ${total} å¼µåœ–ç‰‡`;

            if (current === total) {
                progressText.textContent = 'ğŸ‰ å…¨éƒ¨ç”Ÿæˆå®Œæˆï¼';
            }
        }

        // ç”Ÿæˆå–®ä¸€åœ–ç‰‡
        async function generateSingleImage(key) {
            updatePlantStatus(key, 'generating');

            try {
                // å»ºç«‹åˆ†äº«å¡ç‰‡ DOM
                const shareCard = await shareManager.createShareCardDOM(key);

                // ä¿®æ­£åœ–ç‰‡è·¯å¾‘ï¼ˆå› ç‚ºå·¥å…·åœ¨ tools/ å­è³‡æ–™å¤¾ä¸­ï¼‰
                const images = shareCard.querySelectorAll('img');
                images.forEach(img => {
                    // å°‡ images/xxx.png æ”¹ç‚º ../images/xxx.png
                    if (img.src && img.src.includes('images/')) {
                        const currentSrc = img.getAttribute('src');
                        if (currentSrc && !currentSrc.startsWith('../')) {
                            img.setAttribute('src', '../' + currentSrc);
                        }
                    }
                });

                document.body.appendChild(shareCard);

                // ç­‰å¾… DOM æ¸²æŸ“å’Œåœ–ç‰‡è¼‰å…¥
                await new Promise(resolve => setTimeout(resolve, 500));

                // ä½¿ç”¨ html2canvas æˆªåœ–
                const canvas = await html2canvas(shareCard, {
                    width: 1080,
                    height: 1600,
                    scale: 1,
                    backgroundColor: '#fffaf5',
                    logging: false,
                    useCORS: true,
                    allowTaint: true
                });

                // ç§»é™¤è‡¨æ™‚ DOM
                document.body.removeChild(shareCard);

                // è½‰æ›ç‚º blob ä¸¦ä¸‹è¼‰
                return new Promise((resolve, reject) => {
                    canvas.toBlob(blob => {
                        if (!blob) {
                            updatePlantStatus(key, 'error');
                            reject(new Error('Blob ç”Ÿæˆå¤±æ•—'));
                            return;
                        }

                        // ä¸‹è¼‰æª”æ¡ˆ
                        const url = URL.createObjectURL(blob);
                        const link = document.createElement('a');
                        link.download = `${key}.png`;
                        link.href = url;
                        link.click();
                        URL.revokeObjectURL(url);

                        updatePlantStatus(key, 'success');
                        resolve();
                    }, 'image/png');
                });

            } catch (error) {
                console.error(`ç”Ÿæˆ ${key} åœ–ç‰‡å¤±æ•—:`, error);
                updatePlantStatus(key, 'error');
                throw error;
            }
        }

        // ç”Ÿæˆå…¨éƒ¨åœ–ç‰‡
        async function generateAllImages() {
            progressInfo.style.display = 'block';
            generateAllBtn.disabled = true;

            let successCount = 0;

            for (let i = 0; i < plantKeys.length; i++) {
                const key = plantKeys[i];

                try {
                    await generateSingleImage(key);
                    successCount++;
                    updateProgress(successCount, plantKeys.length);

                    // æ¯å¼µåœ–ç‰‡ä¹‹é–“å»¶é² 500msï¼Œé¿å…ç€è¦½å™¨é˜»æ“‹å¤šæ¬¡ä¸‹è¼‰
                    if (i < plantKeys.length - 1) {
                        await new Promise(resolve => setTimeout(resolve, 500));
                    }
                } catch (error) {
                    console.error(`ç”Ÿæˆ ${key} å¤±æ•—:`, error);
                }
            }

            generateAllBtn.disabled = false;
            resetBtn.style.display = 'inline-block';

            if (successCount === plantKeys.length) {
                alert('ğŸ‰ å…¨éƒ¨ 6 å¼µåœ–ç‰‡ç”Ÿæˆå®Œæˆï¼\n\nè«‹åˆ°ã€Œä¸‹è¼‰ã€è³‡æ–™å¤¾æŸ¥çœ‹æª”æ¡ˆï¼Œç„¶å¾Œï¼š\n1. ç§»å‹•åˆ°å°ˆæ¡ˆçš„ share/ è³‡æ–™å¤¾\n2. é‡æ–°å‘½åï¼Œç§»é™¤ share- å‰ç¶´');
            } else {
                alert(`ç”Ÿæˆå®Œæˆï¼æˆåŠŸ ${successCount} / ${plantKeys.length} å¼µã€‚\n\nå¤±æ•—çš„åœ–ç‰‡å¯ä»¥é»æ“Šå€‹åˆ¥æŒ‰éˆ•é‡æ–°ç”Ÿæˆã€‚`);
            }
        }

        // é‡ç½®ç‹€æ…‹
        function resetStatus() {
            plantKeys.forEach(key => {
                plantStatus[key] = 'pending';
            });
            renderPlantCards();
            progressInfo.style.display = 'none';
            progressFill.style.width = '0%';
            resetBtn.style.display = 'none';
        }

        // äº‹ä»¶ç›£è½
        generateAllBtn.addEventListener('click', generateAllImages);
        resetBtn.addEventListener('click', resetStatus);

        // åˆå§‹åŒ–æ¸²æŸ“
        renderPlantCards();
    </script>
</body>
</html>

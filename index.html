<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ‰¾åˆ°ä½ çš„æƒ…ç·’åº§æ¨™ | Nuvayae Scent Lab</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:wght@400;600&family=Noto+Serif+TC:wght@400;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="css/share-card.css">
    <!-- html2canvas for share image generation -->
    <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
</head>

<body>
    <!-- æ£®æ—èƒŒæ™¯å±¤ -->
    <div class="forest-background">
        <div class="bg-layer bg-layer-far"></div>
        <div class="bg-layer bg-layer-mid"></div>
        <div class="bg-layer bg-layer-near"></div>
    </div>

    <!-- è¼‰å…¥å‹•ç•«ç•«é¢ -->
    <div class="loading-screen" id="loadingScreen">
        <div class="loading-icon">ğŸŒ¿</div>
        <div class="loading-text" id="loadingText">æ­£åœ¨åˆ†æä½ çš„æƒ…ç·’åº§æ¨™...</div>
        <div class="loading-spinner"></div>
    </div>

    <div class="container">
        <div class="brand-header">
            <div class="brand-logo">NUVAYAE SCENT LAB</div>
            <h1>ğŸŒ¿ æ‰¾åˆ°ä½ çš„æƒ…ç·’åº§æ¨™</h1>
            <p>ä¾†è‡ªå°ç£çš„é¦™æ°£ç ”è£½æ‰€</p>
        </div>

        <div class="content">
            <!-- é–‹å§‹ç•«é¢ -->
            <div class="start-screen" id="startScreen">
                <h2>æƒ…ç·’åº§æ¨™æ¸¬é©—</h2>
                <p>
                    é€é 10 å€‹ç”Ÿæ´»æƒ…å¢ƒå•é¡Œï¼Œ<br>
                    æ‰¾åˆ°å±¬æ–¼ä½ çš„æƒ…ç·’åº§æ¨™èˆ‡æ¤ç‰©äººæ ¼ã€‚<br><br>
                    æ¸¬é©—çµæŸå¾Œï¼Œä½ æœƒç²å¾—ï¼š<br>
                    âœ¨ å°ˆå±¬ç™‚ç™’é¦™æ°£èƒ½é‡<br>
                    ğŸŒ± é©åˆèˆ‡ä½ ä¸€èµ·ç”Ÿæ´»çš„æ¤ç‰©å€‘
                </p>
                <button class="btn" id="startBtn">é–‹å§‹æ¸¬é©—</button>
            </div>

            <!-- æ¸¬é©—ç•«é¢ -->
            <div class="question-screen" id="questionScreen">
                <div class="progress-insight" id="progressInsight"></div>
                <div class="progress-container">
                    <div class="progress-bar" id="progressBar"></div>
                </div>
                <div class="question-number" id="questionNumber">ç¬¬ 1 æ­¥ / å…± 10 æ­¥</div>
                <div class="question-text" id="questionText"></div>
                <div class="options" id="optionsContainer"></div>
                <div class="feedback-message" id="feedbackMessage"></div>
            </div>

            <!-- çµæœç•«é¢ -->
            <div class="result-screen" id="resultScreen">
                <img class="plant-icon" id="plantIcon" src="" alt="æ¤ç‰©åœ–ç‰‡">
                <div class="plant-name" id="plantName"></div>
                <div class="plant-tagline" id="plantTagline"></div>
                <div class="description" id="plantDescription"></div>

                <div class="coord-container">
                    <div class="coord-title" id="coordTitle"></div>
                    <div class="coord-subtitle" id="coordSubtitle"></div>
                    <div class="coord-map">
                        <div class="coord-axis vertical"></div>
                        <div class="coord-axis horizontal"></div>
                        <div class="coord-label right">Warm</div>
                        <div class="coord-label left">Cool</div>
                        <div class="coord-label top">Active</div>
                        <div class="coord-label bottom">Calm</div>
                        <div class="coord-point" id="coordPoint"></div>
                    </div>
                </div>

                <div class="relation-section">
                    <div class="relation-title">ğŸŒ± èˆ‡ä½ ç›¸è™•çš„æ¤ç‰©å€‘</div>
                    <div class="relation-grid" id="relationGrid"></div>
                </div>

                <div class="scent-section">
                    <div class="scent-title">ğŸ”® é©åˆä½ çš„é¦™æ°£èƒ½é‡</div>
                    <div class="scent-grid" id="scentGrid"></div>
                </div>

                <!-- åˆ†äº«å€å¡Š -->
                <div class="share-section" id="shareSection">
                    <div class="share-title">ğŸ“¤ åˆ†äº«ä½ çš„æ¤ç‰©äººæ ¼</div>
                    <div class="share-buttons">
                        <button class="share-btn download" id="downloadBtn">ğŸ“¥ åˆ†äº«çµæœåœ–</button>
                        <button class="share-btn copy" id="copyLinkBtn">ğŸ”— è¤‡è£½é€£çµ</button>
                    </div>
                    <div class="copy-success" id="copySuccess">âœ… å·²è¤‡è£½åˆ°å‰ªè²¼ç°¿</div>
                </div>

                <button class="btn restart-btn" id="restartBtn">é‡æ–°æ¸¬é©—</button>
            </div>
        </div>

        <div class="brand-footer">
            Nuvayae Scent Lab Â© 2025 | ä¾†è‡ªå°ç£çš„é¦™æ°£ç ”è£½æ‰€
        </div>
    </div>

    <script type="module">
        import { QuizManager } from './js/quiz.js?v=3';
        import { UIManager } from './js/ui.js?v=3';
        import { AnimationManager } from './js/animations.js?v=3';
        import { FeedbackManager } from './js/feedback.js?v=3';
        import { ShareManager } from './js/share.js?v=3';

        // åˆå§‹åŒ–æ‡‰ç”¨
        const quiz = new QuizManager();
        const ui = new UIManager();
        const anim = new AnimationManager();
        const feedback = new FeedbackManager();
        const share = new ShareManager();

        let currentResultKey = null;

        // åˆå§‹åŒ–æ£®æ—èƒŒæ™¯å±¤
        anim.initBackgroundLayers();

        // é–‹å§‹æ¸¬é©—
        function startQuiz() {
            ui.clearFeedback();
            anim.fadeOut(ui.startScreen, 300).then(() => {
                ui.showQuestionScreen();
                anim.fadeIn(ui.questionScreen, 300);
                // æ›´æ–°åˆ°ç¬¬ä¸€é¡Œçš„æ£®æ—æ·±åº¦
                anim.updateForestDepth(1);
                showQuestion();
            });
        }

        // é¡¯ç¤ºé¡Œç›®
        function showQuestion() {
            const question = quiz.getCurrentQuestion();
            ui.updateQuestion(
                question,
                quiz.getCurrentQuestionNumber(),
                quiz.getTotalQuestions(),
                quiz.getProgress()
            );
            ui.renderOptions(question.options, selectAnswer);

            // æª¢æŸ¥æ˜¯å¦éœ€è¦é¡¯ç¤ºéšæ®µæ€§æç¤º
            const insight = feedback.getProgressInsight(quiz.getCurrentQuestionNumber());
            if (insight) {
                ui.showProgressInsight(insight);
            }
        }

        // é¸æ“‡ç­”æ¡ˆ
        function selectAnswer(type) {
            // é¡¯ç¤ºå³æ™‚åé¥‹
            const feedbackText = feedback.getAnswerFeedback(type);
            ui.showFeedback(feedbackText);

            // è¨˜éŒ„ç­”æ¡ˆ
            quiz.recordAnswer(type);

            if (quiz.hasNextQuestion()) {
                // ç­‰å¾…åé¥‹é¡¯ç¤ºå¾Œä½¿ç”¨æ£®æ—æ¢ç´¢å‹•ç•«åˆ‡æ›åˆ°ä¸‹ä¸€é¡Œ
                setTimeout(() => {
                    const nextQuestionNumber = quiz.getCurrentQuestionNumber();

                    // æ›´æ–°æ£®æ—æ·±åº¦
                    anim.updateForestDepth(nextQuestionNumber);

                    // æ›´æ–°é€²åº¦è…³å°
                    anim.updateProgressTrail(nextQuestionNumber, quiz.getTotalQuestions());

                    // ä½¿ç”¨æ£®æ—åˆ‡æ›å‹•ç•«
                    anim.transitionToNextQuestion(
                        ui.questionScreen,
                        ui.questionScreen,
                        () => {
                            showQuestion();
                        }
                    );
                }, 1200);
            } else {
                // å®Œæˆæ‰€æœ‰é¡Œç›®ï¼Œé¡¯ç¤ºçµæœ
                setTimeout(showResult, 1200);
            }
        }

        // é¡¯ç¤ºçµæœ
        async function showResult() {
            // ç¬¬ä¸€éšæ®µï¼šé¡Œç›®ç•«é¢æ·¡å‡º
            await anim.fadeOut(ui.questionScreen, 500);

            // ç¬¬äºŒéšæ®µï¼šè¨ˆç®—çµæœ
            currentResultKey = quiz.calculateResult();

            // å–å¾—æ¤ç‰©è³‡æ–™
            const { plantData } = await import('./js/data/plants.js');
            const plantColor = plantData[currentResultKey].color;

            // ç¬¬ä¸‰éšæ®µï¼šæ£®æ—æ ¸å¿ƒæ­æ›‰å‹•ç•«
            await anim.revealResultWithForest(plantColor, ui.resultScreen);

            // ç¬¬å››éšæ®µï¼šé¡¯ç¤ºçµæœå…§å®¹
            ui.renderResult(currentResultKey);

            // ç¬¬äº”éšæ®µï¼šæ‰“å­—æ©Ÿæ•ˆæœé¡¯ç¤ºæè¿°
            setTimeout(() => {
                const descElement = document.getElementById('plantDescription');
                const descText = descElement.innerHTML;
                descElement.innerHTML = '';
                anim.typewriterEffect(descElement, descText, 30);
            }, 500);

            // åˆå§‹åŒ–åˆ†äº«åŠŸèƒ½
            initShareButtons(currentResultKey);
        }

        // åˆå§‹åŒ–åˆ†äº«æŒ‰éˆ•äº‹ä»¶
        let shareButtonsInitialized = false;
        function initShareButtons(resultKey) {
            if (shareButtonsInitialized) {
                // å·²ç¶“åˆå§‹åŒ–éï¼Œåªéœ€æ›´æ–° resultKey
                return;
            }
            shareButtonsInitialized = true;

            // ä¸‹è¼‰çµæœåœ–
            document.getElementById('downloadBtn').addEventListener('click', async () => {
                await share.generateShareImage(ui.resultScreen, currentResultKey);
            });

            // è¤‡è£½é€£çµ
            document.getElementById('copyLinkBtn').addEventListener('click', async () => {
                const success = await share.copyLink();
                const copySuccess = document.getElementById('copySuccess');
                if (success && copySuccess) {
                    copySuccess.classList.add('show');
                    setTimeout(() => {
                        copySuccess.classList.remove('show');
                    }, 2000);
                }
            });
        }

        // é‡æ–°æ¸¬é©—
        function restartQuiz() {
            quiz.reset();
            feedback.reset();
            ui.clearFeedback();

            // é‡ç½®æ£®æ—å‹•ç•«ç‹€æ…‹
            anim.resetForest();

            anim.fadeOut(ui.resultScreen, 300).then(() => {
                ui.showStartScreen();
                anim.fadeIn(ui.startScreen, 300);
            });
        }

        // äº‹ä»¶ç›£è½
        document.getElementById('startBtn').addEventListener('click', startQuiz);
        document.getElementById('restartBtn').addEventListener('click', restartQuiz);
    </script>
</body>

</html>